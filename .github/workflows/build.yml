name: Build and Deploy to Sandbox

on:
  push:
    branches: [master]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # Checkout code
      - name: Checkout code
        uses: actions/checkout@v3

      # Cache Maven dependencies
      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      # Set up Java
      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          java-version: '11'

      # Build the artifact
      - name: Build Mule artifact
        run: mvn clean package

      # Deploy the artifact
      - name: Deploy Mule application
        env:
          ANYPOINT_USERNAME: ${{ secrets.ANYPOINT_PLATFORM_USERNAME }}
          ANYPOINT_PASSWORD: ${{ secrets.ANYPOINT_PLATFORM_PASSWORD }}
          ANYPOINT_ORG_ID: ${{ secrets.ANYPOINT_ORGANIZATION_ID }}
          ANYPOINT_ENV_ID: ${{ secrets.ANYPOINT_ENVIRONMENT_ID }}
        run: |
          mvn mule:deploy \
            -Danypoint.username=$ANYPOINT_USERNAME \
            -Danypoint.password=$ANYPOINT_PASSWORD \
            -Dorganization.id=$ANYPOINT_ORG_ID \
            -Denvironment.id=$ANYPOINT_ENV_ID \
            -Dapplication.name=mule-gitactions
